cmake_minimum_required(VERSION 2.8.11)
project(pstack CXX)
add_definitions("-std=c++11 -Wall -Wextra")

include_directories("/usr/include/python2.7/")
include_directories(".")

if(NOT PSTACK_BIN)
   SET(PSTACK_BIN pstack)
endif(NOT PSTACK_BIN)

if(NOT ELF_BITS)
if(CMAKE_SIZEOF_VOID_P EQUAL 8)
  SET(ELF_BITS 64)  
endif(CMAKE_SIZEOF_VOID_P EQUAL 8)
if(CMAKE_SIZEOF_VOID_P EQUAL 4)
  SET(ELF_BITS 32)  
endif(CMAKE_SIZEOF_VOID_P EQUAL 4)
endif(NOT ELF_BITS)

if(CMAKE_SIZEOF_VOID_P EQUAL 8 AND ELF_BITS EQUAL 32)
  SET(_32_ON_64 1)  
else()
  SET(_32_ON_64 0)  
endif()

set(dwelfsrc dwarf.cc elf.cc reader.cc util.cc dump.cc)
set(procmansrc dead.cc live.cc process.cc proc_service.cc dwarfproc.cc procdump.cc)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

add_definitions("-DELF_BITS=${ELF_BITS}")
add_definitions("-D_FILE_OFFSET_BITS=64")
add_definitions("-D_LARGEFILE_SOURCE")

add_executable(canal canal.cc)
add_executable(${PSTACK_BIN} pstack.cc)

add_library(dwelf-static STATIC ${dwelfsrc})
add_library(dwelf-shared SHARED ${dwelfsrc})
add_library(procman-static STATIC ${procmansrc})
add_library(procman-shared SHARED ${procmansrc})

target_link_libraries(procman-shared dwelf-shared)
target_link_libraries(procman-static dwelf-static)
target_link_libraries(${PSTACK_BIN} dwelf-static procman-static "-lthread_db")
target_link_libraries(canal dwelf-static procman-static "-lthread_db")
target_link_libraries(procman-shared "-lthread_db")

set_target_properties(dwelf-shared PROPERTIES VERSION 1.0.0 SOVERSION 1)
set_target_properties(procman-shared PROPERTIES VERSION 1.0.0 SOVERSION 1)
set_target_properties(dwelf-static PROPERTIES OUTPUT_NAME dwelf)
set_target_properties(dwelf-shared PROPERTIES OUTPUT_NAME dwelf)
set_target_properties(procman-static PROPERTIES OUTPUT_NAME procman)
set_target_properties(procman-shared PROPERTIES OUTPUT_NAME procman)

if (_32_ON_64 EQUAL 1)
    add_definitions("-m32")
    set_target_properties(${PSTACK_BIN} PROPERTIES LINK_FLAGS -m32)
    set_target_properties(procman-shared PROPERTIES LINK_FLAGS -m32)
    set_target_properties(dwelf-shared PROPERTIES LINK_FLAGS -m32)
    set_target_properties(canal PROPERTIES LINK_FLAGS -m32)
endif()

install(TARGETS ${PSTACK_BIN} canal DESTINATION bin)
install(TARGETS dwelf-static dwelf-shared procman-static procman-shared DESTINATION lib)
install(DIRECTORY libpstack DESTINATION include)
